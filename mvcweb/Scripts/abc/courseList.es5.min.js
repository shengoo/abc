"use strict";$(function(){var n,e,u=null,t=[0,0,0],f=$(".courselist"),i=$(".classEvaluate .remark"),o=null,s=function(n,t){webAbc.ajax({url:$.url+"/Member/getclassplan",data:n,success:function(i){t(n,i)}})},r=window.parent.CurrentUser.Type;r==1?(webAbc.markStar({container:i,title:"教学质量",fn:function(n){t[0]=n}}),webAbc.markStar({container:i,title:"教师态度",fn:function(n){t[1]=n}}),webAbc.markStar({container:i,title:"课堂气氛",fn:function(n){t[2]=n}})):r==3&&(webAbc.markStar({container:i,title:"学习能力",fn:function(n){t[0]=n}}),webAbc.markStar({container:i,title:"学习态度",fn:function(n){t[1]=n}}),webAbc.markStar({container:i,title:"掌握程度",fn:function(n){t[2]=n}}));$(".classEvaluate .btntiny").on("click",function(){var i=$(this).attr("action"),r=$(".evaluatecontent").val();if(i=="close"){$(".layui-layer-close").click();return}if(t[0]==0||t[1]==0||t[2]==0){webAbc.showMessage(2,"请打分！");return}if(!r){webAbc.showMessage(2,"请写上您的评价！");return}webAbc.ajax({url:"/Member/CreateClassComment",data:{ClassId:n.ClassId,CplId:e.CplId,Content:$(".evaluatecontent").val(),Rate1:t[0],Rate2:t[1],Rate3:t[2],CommentType:n.CategoryCode},success:function(){webAbc.showMessage(1,"评价成功！");setTimeout(function(){layer.closeAll()},2e3)}})});var h=function(n,i){var r=$(".classEvaluate");$.ajax({url:$.url+"/Member/GetLessonComment",type:"post",data:{cplId:n,isPublic:i},dataType:"json",success:function(n){if(n.IsSuccess){n.Result?(t=[n.Result.Rate1,n.Result.Rate2,n.Result.Rate3],$(".evaluatecontent").val(n.Result.Content),$(".btntiny",r).html("关闭"),$(".btntiny",r).attr("action","close")):($(".evaluatecontent").val(""),t=[0,0,0],$(".btntiny",r).html("提交"),$(".btntiny",r).attr("action","submit"));var i=$(".rate img");$.each(t,function(n,t){for(var r=0;r<5;r++)i[r+n*5].src=r<t?$.url+"/Images/star-on.png":$.url+"/Images/star-off.png"})}else webAbc.showMessage(2,n.ErrMsg)}})},c=function(t,i){var f=t.TeacherEnName||t.TeacherCNName||"暂无分配",e=f=="暂无分配"?"-":t.ClassDate+" "+t.BeginTime+"~"+t.EndTime,u="<tr><td>"+t.LessonNo+"<\/td><td>"+f+'<\/td><td title="'+t.ManagerName+'">'+(webAbc.getCharLength(t.ManagerName)<18?t.ManagerName||"":t.ManagerName.substr(0,14)+"..")+"<\/td><td>"+t.CurrStudentNum+"/"+t.MaxStudentNum+"<\/td><td>"+e+"<\/td><td>"+t.Clength+"<\/td><td>"+t.LessonStatusName+"<\/td>";if(f!="暂无分配")switch(i){case"0":u+="<td>";r=="1"&&n.ClassModel==1&&n.CategoryCode!="1"&&(u+='<a class="btntiny" action="Yuyue">立即预约<\/a>');u+="<\/td><\/tr>";break;case"1":u+='<td style="width:200px;"><a class="btntiny" action="InClassRoom">进入教室<\/a>';r=="1"&&n.ClassModel==1&&(u+='<a class="btntiny" action="Cancel">取消约课<\/a>');n.CategoryCode<100&&(u+='<a class="btntiny" action="LessonAccess" >课件<\/a><\/td><\/tr>');break;case"2":u+="<td>";n.CategoryCode<100&&(u+='<a class="btntiny" action="LessonAccess" >课件<\/a>');(r=="1"||r=="3"&&n.CategoryCode===1)&&(u+='<a class="btntiny" action="Evaluate">评价<\/a>');u+="<\/td><\/tr>";break;default:u+="<\/tr>"}else u+=i=="3"?"<\/tr>":"<td><\/td><\/tr>";return u},l=function(n,t){n.queryType=="3"?$(".classhour th").eq(7).addClass("hidden"):$(".classhour th").eq(7).removeClass("hidden");webAbc.getPageSetting($(".classhour .page"),t,10,function(t){var i=$($(".classhour tbody")[0]);$("tr",i).remove();t.forEach(function(r){var f=$(c(r,n.queryType));f.addClass(t.indexOf(r)%2?"odd":"opp");i.append(f);console.log($(".btntiny",f));f.find(".btntiny").click(function(){var n=$(this).attr("action");e=r;switch(n){case"Yuyue":$.ajax({url:$.url+"/Member/InsertCourse",dataType:"json",type:"post",data:{planId:r.CplId,classId:r.ClassId},success:function(n){n!=null?n.Result[0].Code>0?(webAbc.showMessage(1,n.Result[0].Message),member.setActiveTab("courselist"),o.click()):webAbc.showMessage(2,n.Result[0].Message):webAbc.showMessage(2,"访问服务器异常，请重试！")}});break;case"Cancel":cancelYuyue(r.CplId,r.CategoryCode,function(){member.setActiveTab("courselist");u.click()});break;case"Evaluate":h(r.CplId,r.CategoryCode>=100);OpenLayer({type:1,title:"课程评价",closeBtn:1,shadeClose:!0,shade:0,area:["480px","360px"],content:$(".classEvaluate")});break;case"InClassRoom":console.log("InClassRoom");inClassRoom(r);break;case"LessonAccess":searchLessonAccess(r.CplId)}})});webAbc.openDom($(".classhour"),"900px")})},a=function(t){$(".classhour li").remove();$("#coursedetail").html("&nbsp;&gt;&nbsp;"+n.CourseName);s({classType:1,queryType:t,courseType:n.CourseType,classId:n.ClassId},l)},v=function(t,i){webAbc.getPageSetting($(".page",f),i,10,function(r){var u=$("tbody",f),e;$("tr",u).remove();e=$(".courselist .nav-tabs li").eq(1).hasClass("focus");r.forEach(function(r){var s=i.indexOf(r),f=$("<tr class="+(s%2?"odd":"opp")+"><td>"+r.CategoryName+"<\/td><td>"+r.LevelName+"<\/td><td>"+r.CourseName+"<\/td><td>"+(r.ClassModel?"自约上课":"固定开课")+"<\/td><td>"+r.FinishCount+"/"+r.LessonCount+'<\/td><td style="width:200px;">'+(t.queryType=="0"&&r.CategoryCode==1?'<div class="btntiny " action="yuyue">发起预约<\/div>':"")+(r.CourseType==-1?"":(t.queryType=="0"&&r.CategoryCode==1?'<div class="btntiny " action="search">查看详情<\/div>':'<div class="btntiny " action="search">'+(e?"发起预约":"查看详情")+"<\/div>")+"<\/td><\/tr>"));u.append(f);f.find(".btntiny").click(function(){var u=$(this).attr("action"),i;n=r;switch(u){case"search":a(t.queryType);o=$(this);break;case"yuyue":i=$(".courseyuyue .title");i.html('<a style="cursor:pointer">我的课程<\/a>&gt;<a>'+n.CategoryName+"&nbsp;-&nbsp;"+r.CourseName+"<a>");i.find("a").eq(0).click(function(){member.setActiveTab("courselist")});member.myCapacityReady(n.ClassId,n.CourseId)}})});webAbc.autoAjustIframeHeight()})};$(".nav-tabs li",f).click(function(n){var t=$(n.target),i=t.attr("data");u&&u.removeClass("focus");u=t;u.addClass("focus");s({classType:0,queryType:i,courseType:2},v)});$(".nav-tabs li",f).eq(0).click()});